<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Graduation party camera</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #000;
            color: #fff;
            overflow: hidden;
            touch-action: manipulation;
            height: 100vh;
            width: 100vw;
            position: fixed;
        }

        /* Graduation Message Card */
        .graduation-card {
            position: fixed;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            background: linear-gradient(135deg, #8a2387, #e94057, #f27121);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.8s ease-out;
        }

        .graduation-card.visible {
            opacity: 1;
        }

        .graduation-card h2 {
            font-size: 28px;
            margin-bottom: 15px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .graduation-card h1 {
            font-size: 50px;
            margin-bottom: 25px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .graduation-card p {
            font-size: 18px;
            line-height: 1.6;
            margin-bottom: 20px;
            color: white;
        }

        .graduation-card .close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 12px 25px;
            border-radius: 30px;
            font-size: 16px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .graduation-card .close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .graduation-cap {
            font-size: 40px;
            margin-bottom: 15px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background-color: #f0f;
            opacity: 0.7;
            z-index: 1999;
        }

        .camera-container {
            height: 95vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* Top control bar */
        .top-controls {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 80px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            z-index: 10;
            background: linear-gradient(to bottom, rgba(0, 0, 0, 0.5) 0%, rgba(0, 0, 0, 0) 100%);
        }

        .flash-control {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            color: white;
        }

        .timer-control {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            color: white;
        }

        /* Camera viewfinder */
        .camera-viewfinder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        /* Front camera view (no mirroring) */
        .front-camera #video {
            transform: scaleX(-1);
            /* Remove mirror effect */
        }

        /* Camera controls */
        .camera-controls {
            position: absolute;
            bottom: 30px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 30px;
            z-index: 10;
        }

        .gallery-preview {
            width: 60px;
            height: 60px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
            cursor: pointer;
        }

        .gallery-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .shutter-button {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: white;
            border: 4px solid rgba(255, 255, 255, 0.5);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .shutter-button:active {
            transform: scale(0.95);
            background: #f0f0f0;
        }

        .shutter-button:disabled {
            background: #888;
            cursor: not-allowed;
        }

        /* Recording indicator */
        .recording-indicator {
            position: absolute;
            width: 20px;
            height: 20px;
            background: red;
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .recording .recording-indicator {
            opacity: 1;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .camera-switch {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            color: white;
        }

        .camera-switch:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Capture modes */
        .capture-modes {
            position: absolute;
            bottom: 130px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 30px;
            z-index: 10;
        }

        .capture-mode {
            color: white;
            font-size: 16px;
            font-weight: 600;
            padding: 6px 14px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            cursor: pointer;
        }

        .capture-mode.active {
            background: rgba(255, 255, 255, 0.4);
        }

        /* Flash effect */
        .flash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 100;
        }

        /* Preview container */
        .preview-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
        }

        .preview-container.active {
            transform: translateY(0);
        }

        .preview-image {
            width: 100%;
            height: 70%;
            object-fit: contain;
        }

        .preview-controls {
            position: absolute;
            bottom: 40px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 40px;
        }

        .preview-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            color: white;
            font-size: 30px;
            touch-action: manipulation;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        .preview-btn.confirm {
            background: rgba(255, 255, 255, 0.9);
            color: black;
        }

        .preview-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Camera indicators */
        .camera-indicators {
            position: absolute;
            top: 90px;
            z-index: 0;
            right: 0;
            display: flex;
            justify-content: center;
            z-index: 10;
        }

        .camera-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            margin: 0 5px;
        }

        .camera-indicator.active {
            color: white;
        }

        /* Focus circle */
        .focus-circle {
            position: absolute;
            width: 80px;
            height: 80px;
            border: 2px solid rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            z-index: 10;
            pointer-events: none;
            opacity: 0;
            transform: scale(0.8);
            transition: opacity 0.3s, transform 0.3s;
        }

        .focus-circle.active {
            opacity: 1;
            transform: scale(1);
        }

        /* Camera grid */
        .camera-grid {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr 1fr;
            opacity: 0.3;
        }

        .grid-line {
            background: rgba(255, 255, 255, 0.2);
        }

        .grid-line.v {
            width: 1px;
            height: 100%;
            justify-self: center;
        }

        .grid-line.h {
            width: 100%;
            height: 1px;
            align-self: center;
        }

        /* Status message */
        .status-message {
            position: absolute;
            bottom: 120px;
            left: 0;
            right: 0;
            text-align: center;
            color: white;
            font-size: 16px;
            z-index: 10;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 20px;
            margin: 0 auto;
            width: fit-content;
            backdrop-filter: blur(10px);
            display: none;
        }

        /* Loading spinner */
        .loading-spinner {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            z-index: 3000;
            display: none;
        }

        .loading-spinner::after {
            content: "";
            display: block;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 4px solid #fff;
            border-color: #fff transparent #fff transparent;
            animation: spinner 1.2s linear infinite;
        }

        @keyframes spinner {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Overlay to prevent interactions during upload */
        .upload-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2500;
            display: none;
        }

        /* Zoom controls */
        .zoom-controls {
            position: absolute;
            right: 20px;
            bottom: 150px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 10;
        }

        .zoom-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            color: white;
            font-size: 18px;
        }

        /* Video player in preview */
        #previewVideo {
            width: 100%;
            height: 70%;
            object-fit: contain;
            display: none;
        }

        /* Recording timer */
        .recording-timer {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: red;
            font-size: 18px;
            font-weight: bold;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 20px;
            display: none;
            z-index: 11;
        }
    </style>
</head>

<body>
    <!-- Graduation Message Card -->
    <div class="graduation-card" id="graduationCard">
        <div class="graduation-cap">🎓</div>
        <h2>اهلاً و سهلاً في</h2>
        <h2>حفل تخرج </h2>
        <h1>نايا زيدان زيدان</h1>
        <p>
            لنلتقط أجمل لحظاتنا الجميلة اليوم ولنحتفظ بذكريات لا تُنسى تدوم مدى الحياة، ولنتشارك هذه اللحظات معاً لنزيد
            من ألقها وروعتها. هذا هو يوم نايا المتألق بكل بريقه وتميزه..!! شاركونا قي تشكيل الالبوم...❤️    
        </p>
        <button class="close-btn" id="closeGraduationCard">Continue to Camera</button>
    </div>

    <!-- Loading spinner and overlay -->
    <div class="upload-overlay" id="uploadOverlay"></div>
    <div class="loading-spinner" id="loadingSpinner"></div>

    <div class="camera-container" id="cameraContainer">
        <!-- Recording timer -->
        <div class="recording-timer" id="recordingTimer">00:00</div>
        
        <!-- Camera viewfinder -->
        <div class="camera-viewfinder" id="cameraViewfinder">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas" style="display: none;"></canvas>

            <!-- Focus circle -->
            <div class="focus-circle"></div>
        </div>

        <!-- Zoom controls -->
       

        <!-- Camera controls -->
        <div class="camera-controls">
            <div class="gallery-preview" id="galleryPreview">
                <img id="lastPhoto"
                    src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60' viewBox='0 0 60 60'%3E%3Crect width='60' height='60' fill='%23333'/%3E%3Cpath d='M30 20L40 35H20L30 20Z' fill='%23555'/%3E%3C/svg%3E"
                    alt="Last photo">
            </div>

            <button id="captureBtn" class="shutter-button">
                <div class="recording-indicator"></div>
            </button>

            <button id="cameraSwitch" class="camera-switch">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>

        <!-- Capture modes -->
        <div class="capture-modes">
            <div class="capture-mode active" data-mode="photo">Photo</div>
            <div class="capture-mode" data-mode="video">Video</div>
        </div>

        <!-- Status message -->
        <div class="status-message" id="statusMessage"></div>
    </div>

    <!-- Preview container -->
    <div class="preview-container" id="previewContainer">
        <img id="previewImage" class="preview-image" src="" alt="Preview">
        <video id="previewVideo" controls></video>
        <div class="preview-controls">
            <button id="retakeBtn" class="preview-btn">
                <i class="fas fa-times"></i>
            </button>
            <button id="saveBtn" class="preview-btn confirm">
                <i class="fas fa-check"></i>
            </button>
        </div>
    </div>

    <script>
        // DOM Elements
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const captureBtn = document.getElementById('captureBtn');
        const cameraSwitch = document.getElementById('cameraSwitch');
        const previewContainer = document.getElementById('previewContainer');
        const previewImage = document.getElementById('previewImage');
        const previewVideo = document.getElementById('previewVideo');
        const retakeBtn = document.getElementById('retakeBtn');
        const saveBtn = document.getElementById('saveBtn');
        const lastPhoto = document.getElementById('lastPhoto');
        const focusCircle = document.querySelector('.focus-circle');
        const galleryPreview = document.getElementById('galleryPreview');
        const statusMessage = document.getElementById('statusMessage');
        const graduationCard = document.getElementById('graduationCard');
        const closeGraduationCard = document.getElementById('closeGraduationCard');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const uploadOverlay = document.getElementById('uploadOverlay');
        const cameraContainer = document.getElementById('cameraContainer');
        const cameraViewfinder = document.getElementById('cameraViewfinder');
        const recordingTimer = document.getElementById('recordingTimer');
       
        const captureModes = document.querySelectorAll('.capture-mode');
        const flash = document.createElement('div');
        flash.className = 'flash';
        document.body.appendChild(flash);

        // State variables
        let stream = null;
        let currentPhoto = null;
        let currentVideo = null;
        let facingMode = 'environment'; // 'environment' for back camera, 'user' for front
        let isUploading = false;
        let isRecording = false;
        let mediaRecorder = null;
        let recordedChunks = [];
        let zoomLevel = 1;
        let maxZoom = 4;
        let minZoom = 1;
        let captureMode = 'photo'; // 'photo' or 'video'
        let recordingStartTime = null;
        let recordingTimerInterval = null;
        let initialPinchDistance = null;
        let initialZoomLevel = null;

        // Show graduation card only once per client (using localStorage)
        function showGraduationCard() {
            // Check if the user has already seen the message
            if (!localStorage.getItem('graduationMessageSeen')) {
                graduationCard.classList.add('visible');
                createConfetti();

                // Auto-hide after 8 seconds
                setTimeout(() => {
                    removeGraduationCard();
                }, 30000);

                // Mark as seen
                localStorage.setItem('graduationMessageSeen', 'true');
            }
        }

        // Remove graduation card from DOM completely
        function removeGraduationCard() {
            if (graduationCard && graduationCard.parentNode) {
                graduationCard.parentNode.removeChild(graduationCard);
            }
        }

        // Create confetti effect
        function createConfetti() {
            const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff'];
            const container = document.body;

            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.top = -20 + 'px';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.width = (5 + Math.random() * 10) + 'px';
                confetti.style.height = (5 + Math.random() * 10) + 'px';
                confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                container.appendChild(confetti);

                // Animate confetti
                const animation = confetti.animate([
                    { transform: 'translateY(0) rotate(0deg)', opacity: 1 },
                    { transform: `translateY(100vh) rotate(${360 * 3}deg)`, opacity: 0 }
                ], {
                    duration: 3000 + Math.random() * 3000,
                    easing: 'cubic-bezier(0.1, 0.8, 0.1, 1)',
                });

                // Remove confetti after animation completes
                animation.onfinish = () => {
                    confetti.remove();
                };
            }
        }

        // Initialize camera
        async function initCamera() {
            try {
                // Stop any existing stream
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }

                // Get camera access with zoom capability
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: facingMode,
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    },
                    audio: captureMode === 'video' // Enable audio for video mode
                });

                video.srcObject = stream;
                video.muted = true
                // Apply front camera class if needed (remove mirroring)
                if (facingMode === 'user') {
                    cameraViewfinder.classList.add('front-camera');
                } else {
                    cameraViewfinder.classList.remove('front-camera');
                }

                // Set up focus effect on video tap
                video.addEventListener('click', handleFocus);

                // Set up pinch-to-zoom
                setupPinchToZoom();

            } catch (error) {
                console.error('Camera error:', error);
                showStatus('Camera error: ' + error.message, true);
            }
        }

        // Setup pinch-to-zoom functionality
        function setupPinchToZoom() {
            let touchStartDistance = 0;
            
            video.addEventListener('touchstart', function(e) {
                if (e.touches.length === 2) {
                    touchStartDistance = Math.hypot(
                        e.touches[0].clientX - e.touches[1].clientX,
                        e.touches[0].clientY - e.touches[1].clientY
                    );
                    initialZoomLevel = zoomLevel;
                }
            });
            
            video.addEventListener('touchmove', function(e) {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    const touchDistance = Math.hypot(
                        e.touches[0].clientX - e.touches[1].clientX,
                        e.touches[0].clientY - e.touches[1].clientY
                    );
                    
                    const zoomFactor = touchDistance / touchStartDistance;
                    const newZoom = initialZoomLevel * zoomFactor;
                    
                    // Apply zoom limits
                    setZoom(Math.max(minZoom, Math.min(maxZoom, newZoom)));
                }
            });
        }

        // Set zoom level
        function setZoom(level) {
            zoomLevel = level;
            video.style.transform = `scale(${zoomLevel})`;
        }

        // Show status message
        function showStatus(message, isError = false) {
            statusMessage.textContent = message;
            statusMessage.style.display = 'block';
            if (isError) {
                statusMessage.style.background = 'rgba(255, 59, 48, 0.7)';
            } else {
                statusMessage.style.background = 'rgba(0, 0, 0, 0.5)';
            }

            setTimeout(() => {
                statusMessage.style.display = 'none';
            }, 3000);
        }

        // Handle focus effect
        function handleFocus(e) {
            const rect = video.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            focusCircle.style.left = `${x - 40}px`;
            focusCircle.style.top = `${y - 40}px`;
            focusCircle.classList.add('active');

            setTimeout(() => {
                focusCircle.classList.remove('active');
            }, 1000);
        }

        // Show loading state
        function showLoading() {
            isUploading = true;
            loadingSpinner.style.display = 'block';
            uploadOverlay.style.display = 'block';

            // Disable all interactive elements
            captureBtn.disabled = true;
            cameraSwitch.disabled = true;
            retakeBtn.disabled = true;
            saveBtn.disabled = true;
        }

        // Hide loading state
        function hideLoading() {
            isUploading = false;
            loadingSpinner.style.display = 'none';
            uploadOverlay.style.display = 'none';

            // Re-enable interactive elements
            captureBtn.disabled = false;
            cameraSwitch.disabled = false;
            retakeBtn.disabled = false;
            saveBtn.disabled = false;
        }

        // Capture photo - FIXED TO HANDLE ZOOM
        function capturePhoto() {
            if (isUploading) return;

            const context = canvas.getContext('2d');
            
            // Set canvas dimensions to match the video's intrinsic size
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            // Calculate the zoomed area
            const zoomFactor = zoomLevel;
            const visibleWidth = video.videoWidth / zoomFactor;
            const visibleHeight = video.videoHeight / zoomFactor;
            
            // Calculate the top-left corner of the zoomed area
            const x = (video.videoWidth - visibleWidth) / 2;
            const y = (video.videoHeight - visibleHeight) / 2;

            // Draw the zoomed portion of the video onto the canvas
            context.drawImage(video, x, y, visibleWidth, visibleHeight, 0, 0, canvas.width, canvas.height);

            // Show flash effect
            flash.style.display = 'block';
            flash.style.opacity = '0.8';
            setTimeout(() => {
                flash.style.opacity = '0';
                setTimeout(() => {
                    flash.style.display = 'none';
                }, 200);
            }, 100);

            // Convert to data URL and show preview
            currentPhoto = canvas.toDataURL('image/jpeg');
            previewImage.src = currentPhoto;
            previewImage.style.display = 'block';
            previewVideo.style.display = 'none';
            previewContainer.classList.add('active');
        }

        // Start video recording
        function startRecording() {
            if (isUploading || isRecording) return;
            
            recordedChunks = [];
            
            try {
                const options = { mimeType: 'video/webm; codecs=vp9' };
                mediaRecorder = new MediaRecorder(stream, options);
                
                mediaRecorder.ondataavailable = function(e) {
                    if (e.data.size > 0) {
                        recordedChunks.push(e.data);
                    }
                };
                
                mediaRecorder.onstop = function() {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    currentVideo = URL.createObjectURL(blob);
                    previewVideo.src = currentVideo;
                    previewImage.style.display = 'none';
                    previewVideo.style.display = 'block';
                    previewContainer.classList.add('active');
                    
                    // Reset recording state
                    isRecording = false;
                    captureBtn.classList.remove('recording');
                    recordingTimer.style.display = 'none';
                    clearInterval(recordingTimerInterval);
                };
                
                mediaRecorder.start();
                isRecording = true;
                // край.classList.add('recording');
                
                // Start recording timer
                recordingStartTime = Date.now();
                recordingTimer.style.display = 'block';
                updateRecordingTimer();
                recordingTimerInterval = setInterval(updateRecordingTimer, 1000);
                
            } catch (e) {
                console.error('MediaRecorder error:', e);
                showStatus('Video recording not supported', true);
            }
        }

        // Update recording timer
        function updateRecordingTimer() {
            const elapsedTime = Math.floor((Date.now() - recordingStartTime) / 1000);
            const minutes = Math.floor(elapsedTime / 60).toString().padStart(2, '0');
            const seconds = (elapsedTime % 60).toString().padStart(2, '0');
            recordingTimer.textContent = `${minutes}:${seconds}`;
        }

        // Stop video recording
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
            }
        }

        // Handle capture button click based on mode
        function handleCapture() {
            if (captureMode === 'photo') {
                capturePhoto();
            } else {
                if (isRecording) {
                    stopRecording();
                } else {
                    startRecording();
                }
            }
        }

        // Save photo to server
        async function savePhoto() {
            if (isUploading) return;

            try {
                showLoading();
                
                if (captureMode === 'photo') {
                    showStatus('Uploading photo...');
                    const blob = await fetch(currentPhoto).then(r => r.blob());
                    const formData = new FormData();
                    formData.append('photo', blob, `photo_${Date.now()}.jpg`);
                    
                    // Send to server
                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        // Update the gallery preview
                        lastPhoto.src = currentPhoto;
                        showStatus('Photo saved successfully!');
                    } else {
                        showStatus('Upload failed: ' + result.error, true);
                    }
                } else {
                    showStatus('Uploading video...');
                    
                    // Convert video URL to blob
                    const response = await fetch(currentVideo);
                    const blob = await response.blob();
                    
                    const formData = new FormData();
                    formData.append('video', blob, `video_${Date.now()}.webm`);
                    
                    // Send to server
                    const uploadResponse = await fetch('/upload-video', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await uploadResponse.json();
                    if (result.success) {
                        showStatus('Video saved successfully!');
                    } else {
                        showStatus('Upload failed: ' + result.error);
                    }
                }
                
                // Hide preview after a short delay
                setTimeout(() => {
                    previewContainer.classList.remove('active');
                    hideLoading();
                }, 1500);
                
            } catch (error) {
                console.error('Upload error:', error);
                showStatus('Upload error: ' + error.message, true);
                hideLoading();
            }
        }

        // Switch between front and back camera
        async function switchCamera() {
            if (isUploading || isRecording) return;

            facingMode = facingMode === 'environment' ? 'user' : 'environment';
            await initCamera();
        }

        // Switch capture mode
        function switchCaptureMode(mode) {
            if (isRecording) return;
            
            captureMode = mode;
            captureModes.forEach(m => {
                if (m.dataset.mode === mode) {
                    m.classList.add('active');
                } else {
                    m.classList.remove('active');
                }
            });
            
            // Reinitialize camera with correct audio settings
            initCamera();
        }

        // Navigate to gallery
        function goToGallery() {
            if (isUploading || isRecording) return;
            window.location.href = '/gallery';
        }

        // Event listeners
        captureBtn.addEventListener('click', handleCapture);
        cameraSwitch.addEventListener('click', switchCamera);
        retakeBtn.addEventListener('click', () => {
            if (isUploading) return;
            previewContainer.classList.remove('active');
        });
        saveBtn.addEventListener('click', savePhoto);
        galleryPreview.addEventListener('click', goToGallery);
        closeGraduationCard.addEventListener('click', removeGraduationCard);
        
      
        
        // Capture mode selection
        captureModes.forEach(mode => {
            mode.addEventListener('click', () => {
                switchCaptureMode(mode.dataset.mode);
            });
        });

        // Initialize camera on load
        window.addEventListener('load', () => {
            initCamera();
            // Show graduation message after a short delay (only once per client)
            setTimeout(showGraduationCard, 500);
        });

        // Handle orientation changes
        window.addEventListener('orientationchange', initCamera);
    </script>
</body>

</html>